const R={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0},T=(s,t)=>{const o=String.fromCharCode(97+t),e=8-s;return`${o}${e}`},D=s=>{const t=s.charCodeAt(0)-97;return{row:8-parseInt(s[1],10),col:t}},O=(s,t,o,e,n)=>{const i=o>s?1:o<s?-1:0,c=e>t?1:e<t?-1:0;let r=s+i,l=t+c;for(;r!==o||l!==e;){if(n[r][l])return!1;r+=i,l+=c}return!0},d=(s,t)=>{for(let o=0;o<8;o++)for(let e=0;e<8;e++){const n=t[o][e];if(n&&n.type==="king"&&n.color===s)return{row:o,col:e}}return null},$=(s,t,o,e,n=null)=>{for(let i=0;i<8;i++)for(let c=0;c<8;c++){const r=e[i][c];if(r&&r.color===o&&Z(i,c,s,t,r,e,n))return!0}return!1},W=(s,t,o=null)=>{const e=d(s,t);if(!e)return!1;const n=s==="white"?"black":"white";return $(e.row,e.col,n,t,o)},Z=(s,t,o,e,n,i,c=null)=>{if(o<0||o>7||e<0||e>7)return!1;const r=i[o][e];if(r&&r.color===n.color)return!1;const l=o-s,A=e-t,f=Math.abs(l),a=Math.abs(A);switch(n.type){case"pawn":{const h=n.color==="white"?-1:1,u=n.color==="white"?6:1;if(A===0&&!r&&(l===h||s===u&&l===2*h&&!i[s+h][t])||a===1&&l===h&&r)return!0;if(a===1&&l===h&&!r&&c){const k=n.color==="white"?"black":"white",w=n.color==="white"?3:4;if(s===w&&c.piece.type==="pawn"&&c.piece.color===k&&Math.abs(c.toRow-c.fromRow)===2&&c.toRow===s&&c.toCol===e)return!0}return!1}case"rook":return l===0||A===0?O(s,t,o,e,i):!1;case"knight":return f===2&&a===1||f===1&&a===2;case"bishop":return f===a?O(s,t,o,e,i):!1;case"queen":return l===0||A===0||f===a?O(s,t,o,e,i):!1;case"king":if(f<=1&&a<=1)return!0;if(f===0&&a===2&&!n.hasMoved&&!W(n.color,i,c)){const h=A>0?7:0,u=i[s][h];if(u&&u.type==="rook"&&!u.hasMoved&&O(s,t,s,h,i)){const k=A>0?1:-1,w=n.color==="white"?"black":"white";if(!$(s,t+k,w,i,c)&&!$(s,e,w,i,c))return!0}}return!1;default:return!1}},V=(s,t,o,e,n,i=null)=>{const c=n.map(l=>[...l]),r=c[s][t];if(!r)return!1;if(r.type==="king"&&Math.abs(e-t)===2){c[o][e]={...r,hasMoved:!0},c[s][t]=null;const l=e>t?7:0,A=e>t?5:3,f=c[s][l];f&&(c[s][A]={...f,hasMoved:!0},c[s][l]=null)}else r.type==="pawn"&&e!==t&&!c[o][e]&&(c[s][e]=null),c[o][e]=r,c[s][t]=null;return W(r.color,c,i)},q=(s,t,o=null)=>{const e=[];for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=s[n][i];if(!(!c||c.color!==t)){for(let r=0;r<8;r++)for(let l=0;l<8;l++)if(Z(n,i,r,l,c,s,o)&&!V(n,i,r,l,s,o)){const A=T(n,i),f=T(r,l);c.type==="pawn"&&(r===0||r===7)?(e.push({from:A,to:f,promotion:"q"}),e.push({from:A,to:f,promotion:"r"}),e.push({from:A,to:f,promotion:"b"}),e.push({from:A,to:f,promotion:"n"})):e.push({from:A,to:f})}}}return e},y=(s,t,o=null)=>{const e=[];for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=s[n][i];if(!(!c||c.color!==t))for(let r=0;r<8;r++)for(let l=0;l<8;l++){const A=s[r][l],f=A&&A.color!==t,a=c.type==="pawn"&&!A&&Math.abs(l-i)===1&&o&&o.piece.type==="pawn"&&o.piece.color!==t&&Math.abs(o.toRow-o.fromRow)===2&&o.toRow===n&&o.toCol===l;if((f||a)&&Z(n,i,r,l,c,s,o)&&!V(n,i,r,l,s,o)){const h=T(n,i),u=T(r,l);c.type==="pawn"&&(r===0||r===7)?e.push({from:h,to:u,promotion:"q"}):e.push({from:h,to:u})}}}return e},C=[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],U=[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],z=[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],x=[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],P=[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],Q=[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]],G=[[-50,-40,-30,-20,-20,-30,-40,-50],[-30,-20,-10,0,0,-10,-20,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,30,40,40,30,-10,-30],[-30,-10,20,30,30,20,-10,-30],[-30,-30,0,0,0,0,-30,-30],[-50,-30,-30,-30,-30,-30,-30,-50]],j=(s,t,o,e,n=!1)=>{let i;switch(s){case"pawn":i=C;break;case"knight":i=U;break;case"bishop":i=z;break;case"rook":i=x;break;case"queen":i=P;break;case"king":i=n?G:Q;break;default:return 0}const c=e==="white"?t:7-t;return i[c][o]/100},J=s=>{let t=0,o=0;const e={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0};for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=s[n][i];if(c){const r=e[c.type]||0;c.color==="white"?t+=r:o+=r}}return t<=13||o<=13};class Y{table;maxSize;hits=0;probes=0;constructor(t=16){this.table=new Map,this.maxSize=t*1024*1024/100}hashPosition(t,o){let e=o==="white"?"W:":"B:";for(let n=0;n<8;n++)for(let i=0;i<8;i++){const c=t[n][i];c&&(e+=`${c.type[0]}${c.color[0]}${n}${i},`)}return e}store(t,o,e,n,i,c){const r=this.hashPosition(t,o);if(this.table.size>=this.maxSize){const l=this.table.keys().next().value;l&&this.table.delete(l)}this.table.set(r,{zobristHash:r,depth:e,score:n,flag:i,bestMove:c})}probe(t,o,e,n,i){this.probes++;const c=this.hashPosition(t,o),r=this.table.get(c);if(!r||r.depth<e)return null;switch(this.hits++,r.flag){case"EXACT":return r.score;case"ALPHA":if(r.score<=n)return n;break;case"BETA":if(r.score>=i)return i;break}return null}clear(){this.table.clear(),this.hits=0,this.probes=0}getStats(){const t=this.probes>0?this.hits/this.probes*100:0;return{size:this.table.size,maxSize:this.maxSize,hitRate:Math.round(t*10)/10}}}const N=new Y(16),K=(s,t,o,e,n,i,c)=>{let r=0,l=0;const A=J(s);for(let a=0;a<s.length;a++)for(let h=0;h<s[a].length;h++){const u=s[a][h];if(u){const k=R[u.type]||0,w=j(u.type,a,h,u.color,A);u.color===t?(r+=k,l+=w):(r-=k,l-=w)}}let f=r+l;if(o&&e&&n!==void 0&&i!==void 0){const a=e[i];if(a>=n)return 999999;n-a<=9&&(f+=50);for(let u=0;u<e.length;u++){if(u!==i&&e[u]>=n)return-999999;u!==i&&e[u]>=n-9&&(f-=30)}}if(c==="rotating"){let a=0;for(let u=0;u<8;u++)for(let k=0;k<8;k++)s[u][k]&&a++;(!o||e&&i!==void 0&&e[i]<(n||20)*.7)&&(f+=(a-16)*.15),f*=.85;const h=Math.abs(r);h>5&&(f-=(h-5)*.3)}if(c==="random"){let a=0;const h=[[3,3],[3,4],[4,3],[4,4]];for(const[u,k]of h){const w=s[u][k];w&&(w.color===t?a+=.4:a-=.4)}f+=a,f*=.9}if(o&&e&&n!==void 0&&i!==void 0){const a=e[i],h=Math.max(...e.filter((k,w)=>w!==i)),u=a-h;if(u>5){let k=0;for(let w=0;w<8;w++)for(let E=0;E<8;E++){const v=s[w][E];v&&v.type==="king"&&v.color===t&&(v.color==="white"&&w>=6||v.color==="black"&&w<=1)&&(k+=.5)}f+=k,f*=.95}if(u<-5){f*=1.05;let k=0;for(let w=0;w<8;w++)for(let E=0;E<8;E++){const v=s[w][E];v&&v.color===t&&v.type!=="pawn"&&(v.color==="white"?w<6:w>1)&&(k+=.2)}f+=k}}return f},L=new Map,t0=2,o0=()=>{L.clear()},F=(s,t,o)=>{const e=s.map(n=>{let i=0;const{row:c,col:r}=D(n.from),{row:l,col:A}=D(n.to),f=t[c][r],a=t[l][A];if(a){const u=R[a.type]||0,k=f&&R[f.type]||0;i+=u*10-k}a||(L.get(o)||[]).some(k=>k.from===n.from&&k.to===n.to)&&(i+=5),n.promotion&&(i+=8);const h=Math.abs(l-3.5)+Math.abs(A-3.5);return i+=(7-h)*.1,{move:n,score:i}});return e.sort((n,i)=>i.score-n.score),e.map(n=>n.move)},H=(s,t)=>{const o=L.get(t)||[];o.some(e=>e.from===s.from&&e.to===s.to)||(o.unshift(s),o.length>t0&&o.pop(),L.set(t,o))},X=(s,t,o,e,n,i,c,r,l,A,f,a,h,u=0)=>{if(u>=10)return K(s,n,c,r,l,A,f);let w=n;if(f==="rotating"&&a!==void 0&&h!==void 0){const _=a-h;Math.floor(_/2)%2===1&&(w=n==="white"?"black":"white")}const E=K(s,w,c,r,l,A,f);if(E>=o)return o;E>t&&(t=E);const p=y(s,e?w:w==="white"?"black":"white",i);if(p.length===0)return E;if(e){let _=E;for(const M of p){const{board:m,lastMove:B}=I(s,M),g=X(m,t,o,!1,n,B,c,r,l,A,f,a,h!==void 0?h-1:void 0,u+1);if(_=Math.max(_,g),t=Math.max(t,g),o<=t)break}return _}else{let _=E;for(const M of p){const{board:m,lastMove:B}=I(s,M),g=X(m,t,o,!0,n,B,c,r,l,A,f,a,h!==void 0?h-1:void 0,u+1);if(_=Math.min(_,g),o=Math.min(o,g),o<=t)break}return _}},S=(s,t,o,e,n,i,c,r,l,A,f,a,h)=>{let u=i;if(a==="rotating"&&h!==void 0){const p=h-t;Math.floor(p/2)%2===1&&(u=i==="white"?"black":"white")}const k=N.probe(s,u,t,o,e);if(k!==null)return k;const w=o;if(t===0)return X(s,o,e,n,i,c,r,l,A,f,a,h,t);const E=n?u:u==="white"?"black":"white",v=q(s,E,c);if(v.length===0)return W(E,s,c)?n?-999999:999999:0;if(n){let p=-1/0;const _=F(v,s,t);for(const m of _){const{board:B,lastMove:g}=I(s,m),b=S(B,t-1,o,e,!1,i,g,r,l,A,f,a,h);if(p=Math.max(p,b),o=Math.max(o,b),e<=o){H(m,t);break}}const M=p<=w?"ALPHA":p>=e?"BETA":"EXACT";return N.store(s,u,t,p,M),p}else{let p=1/0;const _=F(v,s,t);for(const m of _){const{board:B,lastMove:g}=I(s,m),b=S(B,t-1,o,e,!0,i,g,r,l,A,f,a,h);if(p=Math.min(p,b),e=Math.min(e,b),e<=o){H(m,t);break}}const M=p>=e?"BETA":p<=w?"ALPHA":"EXACT";return N.store(s,u,t,p,M),p}},I=(s,t)=>{const o=s.map(f=>[...f]),{row:e,col:n}=D(t.from),{row:i,col:c}=D(t.to),r=o[e][n];if(!r)return{board:s,lastMove:null};const l={...r,hasMoved:!0};if(t.promotion&&(l.type=t.promotion==="n"?"knight":t.promotion==="b"?"bishop":t.promotion==="r"?"rook":"queen"),r.type==="king"&&Math.abs(c-n)===2){const f=c>n,a=f?7:0,h=f?5:3,u=o[e][a];u&&(o[e][h]={...u,hasMoved:!0},o[e][a]=null)}return r.type==="pawn"&&c!==n&&!o[i][c]&&(o[e][c]=null),o[i][c]=l,o[e][n]=null,{board:o,lastMove:{fromRow:e,fromCol:n,toRow:i,toCol:c,piece:l}}};self.addEventListener("message",s=>{const{id:t,moves:o,board:e,aiColor:n,lastMove:i,searchDepth:c,isPointsGame:r,playerScores:l,targetScore:A,currentPlayerIndex:f,gameMode:a}=s.data;try{const h=performance.now();console.log(`[Worker ${t}] Started evaluating ${o.length} moves at depth ${c}`),o0();const u=[];for(let w=0;w<o.length;w++){const E=o[w],v=performance.now(),{board:p,lastMove:_}=I(e,E),M=S(p,c-1,-1/0,1/0,!1,n,_,r,l,A,f,a,c),m=performance.now()-v;console.log(`[Worker ${t}] Move ${w+1}/${o.length} (${E.from}â†’${E.to}): ${M.toFixed(2)} in ${m.toFixed(0)}ms`),u.push({move:E,score:M})}const k=performance.now()-h;console.log(`[Worker ${t}] Completed ${o.length} moves in ${k.toFixed(0)}ms (avg: ${(k/o.length).toFixed(0)}ms/move)`),self.postMessage({id:t,results:u})}catch(h){console.error(`[Worker ${t}] Error:`,h),self.postMessage({id:t,results:[],error:h instanceof Error?h.message:"Unknown worker error"})}});
